package main

import (
	"encoding/json"
	"testing"
)

func TestConvertAgentcloudsRequestsResponseToBuildStatisticsCanConvert(t *testing.T) {
	jsonString := `{"count":95873,"value":[{"agentCloudId":1,"requestId":"df8bb7f6-cd13-473e-8501-0002e6339140","pool":{"id":169,"isHosted":false,"poolType":"automation","size":0,"isLegacy":null,"options":null},"agent":{"id":609,"name":null,"version":null,"status":0,"provisioningState":null},"agentSpecification":{"VMImage":"Ubuntu16"},"agentData":{"RequestId":53253677},"provisionRequestTime":"2019-12-02T08:56:48.3006434Z","provisionedTime":null,"agentConnectedTime":"2019-12-02T08:56:51.727Z","releaseRequestTime":"2019-12-02T09:01:06.9160742Z"},{"agentCloudId":1,"requestId":"cc57ac12-237d-4d24-a55e-00033369ad75","pool":{"id":169,"isHosted":false,"poolType":"automation","size":0,"isLegacy":null,"options":null},"agent":{"id":607,"name":null,"version":null,"status":0,"provisioningState":null},"agentSpecification":{"VMImage":"vs2017-win2016"},"agentData":{"RequestId":57205591},"provisionRequestTime":"2020-01-14T12:12:35.1830738Z","provisionedTime":null,"agentConnectedTime":"2020-01-14T12:12:37.93Z","releaseRequestTime":"2020-01-14T12:13:29.7384754Z"},{"agentCloudId":1,"requestId":"5cae837a-94bc-473f-b0c8-00044baab3b3","pool":{"id":169,"isHosted":false,"poolType":"automation","size":0,"isLegacy":null,"options":null},"agent":{"id":609,"name":null,"version":null,"status":0,"provisioningState":null},"agentSpecification":{"vmImage":"ubuntu-latest"},"agentData":{"RequestId":59276306},"provisionRequestTime":"2020-01-30T14:02:18.3487526Z","provisionedTime":null,"agentConnectedTime":"2020-01-30T14:02:23.327Z","releaseRequestTime":"2020-01-30T14:28:26.4553648Z"}]}`

	agentcloudsResponse := AgentcloudsRequestsResponse{}
	json.Unmarshal([]byte(jsonString), &agentcloudsResponse)

	buildStatistics := ConvertAgentcloudsRequestsResponseToBuildStatistics(agentcloudsResponse)

	expectedBuildStatistics := 3
	if len(buildStatistics) != expectedBuildStatistics {
		t.Error("build statistics count was not the expected: % ")
	}
}

func TestConvertAgentRequestsResponseToBuildStatisticsCanConvert(t *testing.T) {
	jsonString := `{"count":251,"value":[{"requestId":504707,"queueTime":"2020-06-04T12:16:07.0133333Z","assignTime":"2020-06-04T12:16:07.0433333Z","receiveTime":"2020-06-04T12:16:13.3667648Z","lockedUntil":"2020-06-04T13:01:07.0433333Z","serviceOwner":"00025394-6065-48ca-87d9-7f5672854ef7","hostId":"564c8796-d9cf-412e-8ed3-a5a07bb574d2","scopeId":"f8934b46-10cc-4e8f-9294-150a98549235","planType":"Build","planId":"7e3d7d96-d1e6-4bab-8149-1b2e9b476226","jobId":"2831d33e-84dd-5533-eda0-8105954f1bc8","demands":["Agent.Version -gtVersion 2.163.1"],"reservedAgent":{"_links":{"self":{"href":"https://dev.azure.com/dfds/_apis/distributedtask/pools/169/agents/608"},"web":{"href":"https://dev.azure.com/dfds/_admin/_AgentPool#_a=agents&poolId=169&agentId=608"}},"id":608,"name":"Azure Pipelines 2","version":"2.169.1","osDescription":"Linux 5.3.0-1020-azure #21~18.04.1-Ubuntu SMP Wed Apr 15 09:35:56 UTC 2020","enabled":true,"status":"online","provisioningState":"RunningRequest","accessPoint":"VstsAccessMapping"},"definition":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/definition?definitionId=1630"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Definitions/1630"}},"id":1630,"name":"Logistics.Instruction.EventForwarder.JobState CI"},"owner":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/results?buildId=248479"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Builds/248479"}},"id":248479,"name":"0.1.47"},"data":{"ParallelismTag":"Private","IsScheduledKey":"False"},"poolId":169,"agentDelays":[],"agentSpecification":{"vmImage":"ubuntu-latest"},"orchestrationId":"7e3d7d96-d1e6-4bab-8149-1b2e9b476226.ci.build.__default","matchesAllAgentsInPool":true},{"requestId":504705,"queueTime":"2020-06-04T12:15:57.08Z","assignTime":"2020-06-04T12:15:57.13Z","receiveTime":"2020-06-04T12:16:04.033946Z","finishTime":"2020-06-04T12:17:40.4766667Z","result":"succeeded","serviceOwner":"00025394-6065-48ca-87d9-7f5672854ef7","hostId":"564c8796-d9cf-412e-8ed3-a5a07bb574d2","scopeId":"f8934b46-10cc-4e8f-9294-150a98549235","planType":"Build","planId":"a9496fbc-3825-4184-a39a-6c3c0fe7a777","jobId":"12f1170f-54f2-53f3-20dd-22fc7dff55f9","demands":["Agent.Version -gtVersion 2.163.1"],"reservedAgent":{"_links":{"self":{"href":"https://dev.azure.com/dfds/_apis/distributedtask/pools/169/agents/607"},"web":{"href":"https://dev.azure.com/dfds/_admin/_AgentPool#_a=agents&poolId=169&agentId=607"}},"id":607,"name":"Hosted Agent","version":"2.169.1","osDescription":"Linux 5.3.0-1020-azure #21~18.04.1-Ubuntu SMP Wed Apr 15 09:35:56 UTC 2020","enabled":true,"status":"offline","provisioningState":"Deallocated","accessPoint":"VstsAccessMapping"},"definition":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/definition?definitionId=1275"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Definitions/1275"}},"id":1275,"name":"Logisitics.Tracking.Trimble"},"owner":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/results?buildId=248478"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Builds/248478"}},"id":248478,"name":"0.1.106"},"data":{"ParallelismTag":"Private","IsScheduledKey":"False"},"poolId":169,"agentDelays":[],"agentSpecification":{"vmImage":"ubuntu-latest"},"orchestrationId":"a9496fbc-3825-4184-a39a-6c3c0fe7a777.job.__default","matchesAllAgentsInPool":true},{"requestId":504702,"queueTime":"2020-06-04T12:13:51Z","assignTime":"2020-06-04T12:13:51.04Z","receiveTime":"2020-06-04T12:13:56.4659788Z","finishTime":"2020-06-04T12:15:02.1Z","result":"succeeded","serviceOwner":"00025394-6065-48ca-87d9-7f5672854ef7","hostId":"564c8796-d9cf-412e-8ed3-a5a07bb574d2","scopeId":"f8934b46-10cc-4e8f-9294-150a98549235","planType":"Build","planId":"494bc54c-5bef-43a0-9078-f743498f589f","jobId":"2831d33e-84dd-5533-eda0-8105954f1bc8","demands":["Agent.Version -gtVersion 2.163.1"],"reservedAgent":{"_links":{"self":{"href":"https://dev.azure.com/dfds/_apis/distributedtask/pools/169/agents/607"},"web":{"href":"https://dev.azure.com/dfds/_admin/_AgentPool#_a=agents&poolId=169&agentId=607"}},"id":607,"name":"Hosted Agent","version":"2.169.1","osDescription":"Linux 5.3.0-1020-azure #21~18.04.1-Ubuntu SMP Wed Apr 15 09:35:56 UTC 2020","enabled":true,"status":"offline","provisioningState":"Deallocated","accessPoint":"VstsAccessMapping"},"definition":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/definition?definitionId=1630"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Definitions/1630"}},"id":1630,"name":"Logistics.Instruction.EventForwarder.JobState CI"},"owner":{"_links":{"web":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_build/results?buildId=248476"},"self":{"href":"https://dfds.visualstudio.com/f8934b46-10cc-4e8f-9294-150a98549235/_apis/build/Builds/248476"}},"id":248476,"name":"0.1.45"},"data":{"ParallelismTag":"Private","IsScheduledKey":"False"},"poolId":169,"agentDelays":[],"agentSpecification":{"vmImage":"ubuntu-latest"},"orchestrationId":"494bc54c-5bef-43a0-9078-f743498f589f.ci.build.__default","matchesAllAgentsInPool":true}]}`

	jobResponse := JobRequestsResponse{}
	json.Unmarshal([]byte(jsonString), &jobResponse)

	buildStatistics := ConvertAgentRequestsResponseToBuildStatistics(jobResponse)

	expectedBuildStatistics := 3
	if len(buildStatistics) != expectedBuildStatistics {
		t.Error("build statistics count was not the expected: % ")
	}
}
